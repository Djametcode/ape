#!/usr/bin/env node
var ape = require('../lib/ape'),
    fs = require('fs'),
    path = require('path'),
    async = require('async'),
    walk = require('walk'),
    argv = require('optimist')
        .usage('Usage: $0 -f [md|html] [file|directory]..')
        .demand(['f'])
        .argv;

var outformat = argv.f;
if (argv._.length === 0) {
    console.log('Usage: ape -f [md|html] [file|directory]..');
    process.exit(1);
}

function process_item(name, callback) {
    fs.stat(name, function (err, stats) {
        if (err) {
            callback(new Error('error opening ' + name));
        } else {
            if (stats.isFile()) {
                ape.supported(name, function (supported) {
                    if (supported) {
                        console.log('processing', name);
                        ape.generate_doc(name, outformat, function (err, output) {
                            callback();
                        });
                    } else {
                        console.log('skipping unsupported file', name);
                    }
                });
            } else if (stats.isDirectory()) {
                var walker = walk.walk(name);
                walker.on('file', function (root, fileStats, next) {
                    var file = path.join(root, fileStats.name);
                    ape.supported(file, function (supported) {
                        if (supported) {
                            console.log('processing', file);
                            ape.generate_doc(file, outformat, function (err, output) {
                                next();
                            });
                        } else {
                            console.log('skipping unsupported file', file);
                            next();
                        }
                    });
                });
                walker.on('end', function () {
                    callback();
                });
            }
        }
    });
}

async.mapSeries(argv._, process_item, function (err) {
    if (err) {
        console.log(err);
        process.exit(1);
    }
});
